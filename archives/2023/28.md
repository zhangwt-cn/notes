---
title: å¤„ç†éæ–‡ä»¶ä¸Šä¼ æ—¶çš„ Multipart è¯·æ±‚è§£æé”™è¯¯
number: '#28'
link: 'https://github.com/zhangwt-cn/notes/issues/28'
created_at: '2023-12-06 20:37:42'
updated_at: '2024-06-21 10:41:28'
labels:
  - Java
---
# å‰å› 
åœ¨å¤„ç†éæ–‡ä»¶ä¸Šä¼ çš„è¯·æ±‚æ—¶ï¼ŒSpringæŠ›å‡ºäº†ä¸€ä¸ªå…³äºMultipartè¯·æ±‚è§£æçš„é”™è¯¯ã€‚
### é”™è¯¯æ—¥å¿—
```bash
Failed to parse multipart servlet request; nested exception is java.io.IOException: The temporary upload location [/tmp/tomcat.8656187483509135391.8020/work/Tomcat/localhost/ROOT] is not valid

org.springframework.web.multipart.MultipartException: Failed to parse multipart servlet request; nested exception is java.io.IOException: The temporary upload location [/tmp/tomcat.8656187483509135391.8020/work/Tomcat/localhost/ROOT] is not valid
```
è¿™ä¸ªé”™è¯¯åœ¨æè¿°ä¸Šæ¥çœ‹æ˜¯å‘ç”Ÿåœ¨æ–‡ä»¶ä¸Šä¼ æ¥å£ï¼Œä½†æ˜¯æŠ¥é”™çš„æ¥å£æ˜¯éä¸Šä¼ æ–‡ä»¶æ¥å£ï¼Œä¹‹å‰æ²¡æœ‰é‡åˆ°è¿‡æ‰€ä»¥è®°å½•ä¸€ä¸‹

# å‡ºç°åŸå› 
- **è¯·æ±‚å¤´è®¾ç½®ä¸æ­£ç¡®**ï¼Œç»è¿‡æ’æŸ¥å‰ç«¯è¯·æ±‚æ¥å£è¯·æ±‚å¤´`Content-Type`è®¾ç½®æˆäº†`multipart/form-data`ï¼Œæ‰€ä»¥ä¼šå‡ºç°éä¸Šä¼ æ¥å£å‡ºç°`MultipartException`
- **Servletä¸´æ—¶ç›®å½•ä¸å­˜åœ¨**ï¼Œ`Servlet`æ¥æ”¶ä¸Šä¼ æ–‡ä»¶æ—¶ä¼šåœ¨`/tmp`ç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶ç›®å½•æé«˜æ€§èƒ½ï¼Œæ‰€ä»¥åœ¨æœåŠ¡å¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»º`tmp/tomcat.8656187483509135391.8020/work/Tomcat/localhost/ROOT`ä¸´æ—¶ç›®å½•ï¼Œä½†æ˜¯ç”±äº`CentOS` ä¼šæ¸…é™¤ä¸´æ—¶æ–‡ä»¶ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°è¿™ä¸ªæŠ¥é”™

# è§£å†³æ–¹æ³•
### 1. ä¿®æ”¹é…ç½®
- è®¾ç½®æ­£ç¡®çš„è¯·æ±‚å¤´
- æ£€æŸ¥`/tmp/tomcat.8656187483509135391.8020/work/Tomcat/localhost/ROOT`æ˜¯å¦æ­£å¸¸ï¼Œé¿å…å†å‡ºç°è¿™æ ·çš„é—®é¢˜ï¼Œæ‰‹åŠ¨é…ç½®æŒ‡å®šè·¯å¾„
  ```yml
  spring:
   servlet:
    multipart:
      location: /path/to
  ```
### 2. è®¾ç½®`CentOS` æ¸…é™¤ä¸´æ—¶ç›®å½•å¿½ç•¥
åœ¨ä¸‹é¢è¿™ä¸ªæ–‡ä»¶ä¸­å¢åŠ ä¸€è¡Œé…ç½®
```bash
/usr/lib/tmpfiles.d/tmp.conf
```
å¢åŠ å†…å®¹
```bash
X /tmp/tomcat.*
```
## ä»¥ä¸Šä¸¤ä¸ªæ–¹æ¡ˆé€‰å…¶ä¸€å³å¯


# å¦å¤–æ”¶è·
åœ¨æŸ¥çœ‹`Spring Boot` æºç çš„æ—¶å€™çœ‹åˆ°ä¸‹é¢è¿™æ®µä»£ç ğŸ‘‡
```Java
 /**
  * Create a new {@link MultipartConfigElement} using the properties.
  * @return a new {@link MultipartConfigElement} configured using there properties
  * */
public MultipartConfigElement createMultipartConfig() {
     MultipartConfigFactory factory = new MultipartConfigFactory();
     PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();
     map.from(this.fileSizeThreshold).to(factory::setFileSizeThreshold);
     map.from(this.location).whenHasText().to(factory::setLocation);
     map.from(this.maxRequestSize).to(factory::setMaxRequestSize);
     map.from(this.maxFileSize).to(factory::setMaxFileSize);
     return factory.createMultipartConfig();
}
```
åœ¨ç”Ÿæˆå†™å…¥`MultipartConfigFactory`å±æ€§æ—¶ï¼Œ`PropertyMapper`å‡å°‘äº†å¾ˆå¤š`if`ï¼Œå¯è¯»æ€§æ›´å¼ºä¹Ÿæ›´åŠ ä¼˜é›…ï¼Œåœ¨æ—¥å¸¸å¼€å‘ä¸­å®ç”¨æ€§å¾ˆå¼º
