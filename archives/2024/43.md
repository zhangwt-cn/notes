---
title: "\U0001F680 Docker éƒ¨ç½² Redis å¸¸è§é—®é¢˜æ’æŸ¥ä¸è§£å†³æ–¹æ¡ˆè®°å½•"
number: '#43'
link: 'https://github.com/zhangwt-cn/notes/issues/43'
created_at: '2024-11-29 14:22:59'
updated_at: '2024-11-29 14:22:59'
labels: []
---
## ğŸ“ å‰è¨€
è®°å½• Docker éƒ¨ç½² Redis è¿‡ç¨‹ï¼Œç•™ä½œå‚è€ƒã€‚
### ä½¿ç”¨ç‰ˆæœ¬
- CentOS 7.9
- Docker 20.10.9
- Redis 6.2.16


## 1. âš™ï¸ åŸºç¡€éƒ¨ç½²é…ç½®

### 1.1 ğŸ“‚ ç›®å½•ç»“æ„
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼š
```bash
mkdir -p /docker/redis/{conf,data}
```
### 1.2 ğŸ“„ åŸºç¡€é…ç½®æ–‡ä»¶

ä¸‹è½½æŒ‡å®šç‰ˆæœ¬ [redis.conf](https://download.redis.io/releases/)ï¼Œè§£å‹åå°† redis.conf æ”¾åˆ° /docker/redis/conf/ ç›®å½•ä¸‹ï¼Œå¹¶åœ¨ /docker/redis/conf/redis.conf ä¸­é…ç½®ä»¥ä¸‹åŸºæœ¬é¡¹ï¼š
```conf title="redis.conf"
bind 0.0.0.0
port 6379
requirepass your_password
protected-mode yes
daemonize no
appendonly yes
```
| é…ç½®é¡¹ | ç¤ºä¾‹å€¼ | ä½œç”¨ | å«ä¹‰ | æ³¨æ„äº‹é¡¹ |
|--------|---------|------|------|----------|
| bind | 0.0.0.0 | æŒ‡å®š Redis ç›‘å¬çš„ç½‘ç»œæ¥å£ | å…è®¸ä»ä»»ä½• IP åœ°å€è®¿é—® Redis æœåŠ¡ | ç”Ÿäº§ç¯å¢ƒå»ºè®®æŒ‡å®šå…·ä½“ IPï¼Œä»¥å¢åŠ å®‰å…¨æ€§ |
| port | 6379 | æŒ‡å®š Redis æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£å· | 6379 æ˜¯ Redis çš„é»˜è®¤ç«¯å£ | å®¢æˆ·ç«¯é€šè¿‡æ­¤ç«¯å£ä¸ Redis å»ºç«‹è¿æ¥ |
| requirepass | your_password | è®¾ç½® Redis è®¿é—®å¯†ç  | å®¢æˆ·ç«¯è¿æ¥éœ€è¦æä¾›å¯†ç éªŒè¯ | å¢åŠ åŸºæœ¬çš„è®¿é—®å®‰å…¨ä¿æŠ¤ |
| protected-mode | yes | ä¿æŠ¤æ¨¡å¼é…ç½® | å¯ç”¨ä¿æŠ¤æ¨¡å¼ï¼Œå¢åŠ å®‰å…¨æ€§ | å½“ bind é…ç½®ä¸º 0.0.0.0 æ—¶ï¼Œå¿…é¡»è®¾ç½®å¯†ç æ‰èƒ½ä»å¤–éƒ¨è®¿é—® |
| daemonize | no | æ˜¯å¦ä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œ | è®¾ä¸º no è¡¨ç¤ºåœ¨å‰å°è¿è¡Œ | å¸¸ç”¨äºå®¹å™¨åŒ–éƒ¨ç½²ï¼Œä¾¿äºå®¹å™¨ç®¡ç† |
| appendonly | yes | æŒä¹…åŒ–ç­–ç•¥é…ç½® | å¯ç”¨ AOF æŒä¹…åŒ–æœºåˆ¶ | â€¢ å®æ—¶è®°å½•å†™æ“ä½œ<br>â€¢ æ•°æ®æ›´å®‰å…¨<br>â€¢ å¯ä»¥å®ç°æ•°æ®æ¢å¤<br>â€¢ é™ä½æ•°æ®ä¸¢å¤±é£é™© |

è¿™äº›é…ç½®ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆäº†ä¸€ä¸ªåŸºæœ¬çš„ã€å®‰å…¨çš„ Redis æœåŠ¡é…ç½®ï¼Œé€‚åˆå®¹å™¨åŒ–éƒ¨ç½²ç¯å¢ƒ

### 1.3 ğŸ”¨ åˆå§‹è¿è¡Œå‘½ä»¤
```bash
docker run -d \
  --name redis \
  --restart always \
  -p 10130:6379 \
  -v /docker/redis/conf/redis.conf:/etc/redis/redis.conf \
  -v /docker/redis/data:/data \
  redis:latest \
  redis-server /etc/redis/redis.conf
```

## 2. ğŸ” é—®é¢˜æ’æŸ¥ä¸è§£å†³

### 2.1 ğŸŒ TCP backlog é—®é¢˜
**é—®é¢˜ç°è±¡**ï¼š
```log
WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä¸´æ—¶è§£å†³
sysctl -w net.core.somaxconn=1024

# æ°¸ä¹…è§£å†³
echo "net.core.somaxconn=1024" >> /etc/sysctl.conf
sysctl -p

# Docker è¿è¡Œå‘½ä»¤æ·»åŠ å‚æ•°
--sysctl net.core.somaxconn=1024
```

### 2.2 ğŸ’¾ å†…å­˜è¿‡åº¦ä½¿ç”¨è­¦å‘Š
**é—®é¢˜ç°è±¡**ï¼š
```log
WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition.
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä¸´æ—¶è§£å†³
sysctl vm.overcommit_memory=1

# æ°¸ä¹…è§£å†³
echo "vm.overcommit_memory=1" >> /etc/sysctl.conf
sysctl -p

# Docker è¿è¡Œå‘½ä»¤æ·»åŠ å‚æ•°
--sysctl vm.overcommit_memory=1
```

### 2.3 ğŸ”‘ åå°ä»»åŠ¡æƒé™é—®é¢˜
**é—®é¢˜ç°è±¡**ï¼š
```log
Fatal: Can't initialize Background Jobs. Error message: Operation not permitted
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ Docker è¿è¡Œå‘½ä»¤ä¸­æ·»åŠ  `--privileged=true` å‚æ•°ï¼Œç»™äºˆå®¹å™¨å¿…è¦çš„ç³»ç»Ÿæƒé™ã€‚[^1]
2. å‡çº§ Docker ç‰ˆæœ¬åˆ° 20.10.10 [^2]

### 2.4 ğŸ“ PID æ–‡ä»¶å†™å…¥æƒé™é—®é¢˜
**é—®é¢˜ç°è±¡**ï¼š
```log
Failed to write PID file: Permission denied
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
chmod -R 777 /docker/redis/data
chmod -R 777 /docker/redis/conf
```

## 3. âœ… æœ€ç»ˆå¯ç”¨é…ç½®

### 3.1 ğŸ› ï¸ å®Œæ•´çš„ Docker è¿è¡Œå‘½ä»¤
```bash
docker run -d \
  --name redis \
  --restart always \
  -p 10130:6379 \
  -v /docker/redis/conf/redis.conf:/etc/redis/redis.conf \
  -v /docker/redis/data:/data \
  --privileged=true \
  redis:latest \
  redis-server /etc/redis/redis.conf
```

### 3.2 âœ”ï¸ éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep redis

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs redis

# æµ‹è¯•è¿æ¥
docker exec -it redis redis-cli -a RedP@ss2024#9K5mL8vX ping
```

## 4. ğŸ“š æœ€ä½³å®è·µå»ºè®®

1. **ğŸ·ï¸ ç‰ˆæœ¬é€‰æ‹©**ï¼š
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬è€Œä¸æ˜¯ latest
   - å¯ä»¥é€‰æ‹©è¾ƒä¸ºç¨³å®šçš„ç‰ˆæœ¬ï¼Œå¦‚ Redis 6.2.16

2. **ğŸ” å®‰å…¨æ€§è€ƒè™‘**ï¼š
   - ä¿®æ”¹é»˜è®¤ç«¯å£
   - è®¾ç½®å¼ºå¯†ç 
   - é™åˆ¶å®¹å™¨èµ„æºä½¿ç”¨

3. **ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤**ï¼š
   - å®šæœŸå¤‡ä»½æ•°æ®
   - ç›‘æ§å®¹å™¨è¿è¡ŒçŠ¶æ€
   - å®šæœŸæ£€æŸ¥æ—¥å¿—

## ğŸ“Œ æ€»ç»“
é€šè¿‡é€æ­¥æ’æŸ¥å’Œè§£å†³å„ç§é—®é¢˜ï¼Œæœ€ç»ˆå®ç°äº† Redis çš„ç¨³å®šè¿è¡Œã€‚å…³é”®åœ¨äºæ­£ç¡®å¤„ç†æƒé™é—®é¢˜å’Œç³»ç»Ÿå‚æ•°é…ç½®ã€‚åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œå»ºè®®æ ¹æ®å…·ä½“ç¯å¢ƒå’Œéœ€æ±‚é€‚å½“è°ƒæ•´é…ç½®å‚æ•°ã€‚

[^1]:[Redis GitHub Issues](https://github.com/redis/redis/issues/12362)
[^2]:[GitHub Wiki](https://github.com/overleaf/overleaf/wiki/Troubleshooting#upgrading-to-redis-62-results-in-a-restart-loop)

